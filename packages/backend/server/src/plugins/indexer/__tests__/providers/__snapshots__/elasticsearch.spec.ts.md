# Snapshot report for `src/plugins/indexer/__tests__/providers/elasticsearch.spec.ts`

The actual snapshot is saved in `elasticsearch.spec.ts.snap`.

Generated by [AVA](https://avajs.dev).

## should batch write bugfix

> Snapshot 1

    [
      {
        _id: 'workspaceId-batch-write-bugfix-for-elasticsearch/a/b1',
        _source: {
          doc_id: 'a',
          workspace_id: 'workspaceId-batch-write-bugfix-for-elasticsearch',
        },
        fields: {
          block_id: [
            'b1',
          ],
          doc_id: [
            'a',
          ],
          workspace_id: [
            'workspaceId-batch-write-bugfix-for-elasticsearch',
          ],
        },
        highlights: undefined,
      },
      {
        _id: 'workspaceId-batch-write-bugfix-for-elasticsearch/a/b2',
        _source: {
          doc_id: 'a',
          workspace_id: 'workspaceId-batch-write-bugfix-for-elasticsearch',
        },
        fields: {
          block_id: [
            'b2',
          ],
          doc_id: [
            'a',
          ],
          workspace_id: [
            'workspaceId-batch-write-bugfix-for-elasticsearch',
          ],
        },
        highlights: undefined,
      },
    ]

## should search block table query match url work

> Snapshot 1

    {
      _id: 'workspaceId1/docId2/blockId8',
      _source: {
        doc_id: 'docId2',
        workspace_id: 'workspaceId1',
      },
      fields: {
        additional: [
          'additional8',
        ],
        content: [
          'title8 hello hello hello hello hello hello hello hello hello hello, hello hello hello hello hello hello hello hello some link https://linear.app/affine-design/issue/AF-1379/slash-commands-%E6%BF%80%E6%B4%BB%E6%8F%92%E5%85%A5-link-%E7%9A%84%E5%BC%B9%E7%AA%97%E9%87%8C%EF%BC%8C%E8%BE%93%E5%85%A5%E9%93%BE%E6%8E%A5%E4%B9%8B%E5%90%8E%E4%B8%8D%E5%BA%94%E8%AF%A5%E7%9B%B4%E6%8E%A5%E5%AF%B9%E9%93%BE%E6%8E%A5%E8%BF%9B%E8%A1%8C%E5%88%86%E8%AF%8D%E6%90%9C%E7%B4%A2',
        ],
        created_at: [
          Date 2025-03-08 06:04:13 278ms UTC {},
        ],
        doc_id: [
          'docId2',
        ],
        markdown_preview: [
          'markdownPreview8',
        ],
        parent_block_id: [
          'parentBlockId8',
        ],
        parent_flavour: [
          'parentFlavour8',
        ],
        ref: [
          '{"docId":"docId1","mode":"page"}',
          '{"docId":"docId2","mode":"page"}',
        ],
        ref_doc_id: [
          'docId1',
        ],
        updated_at: [
          Date 2025-03-08 06:04:13 278ms UTC {},
        ],
      },
      highlights: {
        content: [
          'hello hello hello hello hello hello hello hello, hello hello hello hello hello hello hello hello some <b>link</b>',
          '<b>https</b>://<b>linear.app</b>/<b>affine</b>-<b>design</b>/<b>issue</b>/<b>AF</b>-<b>1379</b>/<b>slash</b>-<b>commands</b>-%<b>E6</b>%<b>BF</b>%<b>80</b>%<b>E6</b>%<b>B4</b>%<b>BB</b>%<b>E6</b>%<b>8F</b>%<b>92</b>%<b>E5</b>%<b>85</b>%<b>A5</b>-<b>link</b>',
          '-%<b>E7</b>%<b>9A</b>%<b>84</b>%<b>E5</b>%<b>BC</b>%<b>B9</b>%<b>E7</b>%<b>AA</b>%<b>97</b>%<b>E9</b>%<b>87</b>%<b>8C</b>%<b>EF</b>%<b>BC</b>%<b>8C</b>%<b>E8</b>%<b>BE</b>%<b>93</b>%<b>E5</b>%<b>85</b>%<b>A5</b>%<b>E9</b>%<b>93</b>%<b>BE</b>%<b>E6</b>%<b>8E</b>%<b>A5</b>%<b>E4</b>%<b>B9</b>%<b>8B</b>%<b>E5</b>%<b>90</b>%<b>8E</b>%',
          '<b>E4</b>%<b>B8</b>%<b>8D</b>%<b>E5</b>%<b>BA</b>%<b>94</b>%<b>E8</b>%<b>AF</b>%<b>A5</b>%<b>E7</b>%<b>9B</b>%<b>B4</b>%<b>E6</b>%<b>8E</b>%<b>A5</b>%<b>E5</b>%<b>AF</b>%<b>B9</b>%<b>E9</b>%<b>93</b>%<b>BE</b>%<b>E6</b>%<b>8E</b>%<b>A5</b>%<b>E8</b>%<b>BF</b>%<b>9B</b>%<b>E8</b>%<b>A1</b>%<b>8C</b>%<b>E5</b>%<b>88</b>%<b>86</b>%<b>E8</b>%',
          '<b>AF</b>%<b>8D</b>%<b>E6</b>%<b>90</b>%<b>9C</b>%<b>E7</b>%<b>B4</b>%<b>A2</b>',
        ],
      },
    }

> Snapshot 2

    {
      _id: 'workspaceId1/docId2/blockId8',
      _source: {
        doc_id: 'docId2',
        workspace_id: 'workspaceId1',
      },
      fields: {
        additional: [
          'additional8',
        ],
        content: [
          'title8 hello hello hello hello hello hello hello hello hello hello, hello hello hello hello hello hello hello hello some link https://linear.app/affine-design/issue/AF-1379/slash-commands-%E6%BF%80%E6%B4%BB%E6%8F%92%E5%85%A5-link-%E7%9A%84%E5%BC%B9%E7%AA%97%E9%87%8C%EF%BC%8C%E8%BE%93%E5%85%A5%E9%93%BE%E6%8E%A5%E4%B9%8B%E5%90%8E%E4%B8%8D%E5%BA%94%E8%AF%A5%E7%9B%B4%E6%8E%A5%E5%AF%B9%E9%93%BE%E6%8E%A5%E8%BF%9B%E8%A1%8C%E5%88%86%E8%AF%8D%E6%90%9C%E7%B4%A2',
        ],
        created_at: [
          Date 2025-03-08 06:04:13 278ms UTC {},
        ],
        doc_id: [
          'docId2',
        ],
        markdown_preview: [
          'markdownPreview8',
        ],
        parent_block_id: [
          'parentBlockId8',
        ],
        parent_flavour: [
          'parentFlavour8',
        ],
        ref: [
          '{"docId":"docId1","mode":"page"}',
          '{"docId":"docId2","mode":"page"}',
        ],
        ref_doc_id: [
          'docId1',
        ],
        updated_at: [
          Date 2025-03-08 06:04:13 278ms UTC {},
        ],
      },
      highlights: {
        content: [
          'hello hello hello hello hello hello hello, hello hello hello hello hello hello hello hello some link <b>https</b>',
          '://<b>linear.app</b>/affine-design/issue/AF-1379/slash-commands-%E6%BF%80%E6%B4%BB%E6%8F%92%E5%85%A5-link-%E7%',
        ],
      },
    }

## should search block table query content match cjk work

> Snapshot 1

    {
      _id: 'workspaceId1/docId2-affine/blockId8',
      _source: {
        doc_id: 'docId2-affine',
        workspace_id: 'workspaceId1',
      },
      fields: {
        content: [
          'AFFiNE 是一个基于云端的笔记应用',
        ],
        doc_id: [
          'docId2-affine',
        ],
        flavour: [
          'flavour8',
        ],
      },
      highlights: {
        content: [
          'AFFiNE 是一个基于云端的<b>笔记应用</b>',
        ],
      },
    }

> Snapshot 2

    {
      _id: 'workspaceId1/docId2-affine/blockId8',
      _source: {
        doc_id: 'docId2-affine',
        workspace_id: 'workspaceId1',
      },
      fields: {
        content: [
          'AFFiNE 是一个基于云端的笔记应用',
        ],
        doc_id: [
          'docId2-affine',
        ],
        flavour: [
          'flavour8',
        ],
      },
      highlights: {
        content: [
          'AFFiNE 是一个基于云端的笔<b>记</b>应用',
        ],
      },
    }

## should search doc table query title match cjk work

> Snapshot 1

    {
      _id: 'workspace-test-doc-title-cjk/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-cjk',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'AFFiNE 是一个基于云端的笔记应用',
        ],
      },
      highlights: {
        title: [
          'AFFiNE 是一个基于云端的<b>笔记应</b>用',
        ],
      },
    }

> Snapshot 2

    {
      _id: 'workspace-test-doc-title-cjk/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-cjk',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'AFFiNE 是一个基于云端的笔记应用',
        ],
      },
      highlights: {
        title: [
          'AFFiNE 是一个基于云端的<b>笔</b>记应用',
        ],
      },
    }

## should search doc table query title.autocomplete work

> Snapshot 1

    {
      _id: 'workspace-test-doc-title-autocomplete/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-autocomplete',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'AFFiNE 是一个基于云端的笔记应用',
        ],
      },
      highlights: {
        'title.autocomplete': [
          '<b>AFF</b>iNE 是一个基于云端的笔记应用',
        ],
      },
    }

## should search query match ref_doc_id work

> Snapshot 1

    [
      {
        fields: {
          additional: [
            '{"foo": "bar0"}',
          ],
          block_id: [
            'blockId1',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId1',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-1',
          ],
        },
      },
      {
        fields: {
          additional: [
            '{"foo": "bar1"}',
          ],
          block_id: [
            'blockId-all',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId2',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-2',
            'doc-3',
            'doc-4',
            'doc-5',
            'doc-6',
            'doc-7',
            'doc-8',
            'doc-9',
            'doc-10',
            'doc-1',
          ],
        },
      },
      {
        fields: {
          additional: [
            '{"foo": "bar1"}',
          ],
          block_id: [
            'blockId1-2',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId2',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-1',
            'doc-2',
          ],
        },
      },
      {
        fields: {
          additional: [
            '{"foo": "bar1"}',
          ],
          block_id: [
            'blockId2-1',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId2',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-2',
            'doc-1',
          ],
        },
      },
      {
        fields: {
          additional: [
            '{"foo": "bar1"}',
          ],
          block_id: [
            'blockId3-2-1-4',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId2',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-3',
            'doc-2',
            'doc-1',
            'doc-4',
          ],
        },
      },
    ]

> Snapshot 2

    [
      {
        fields: {
          additional: [
            '{"foo": "bar1"}',
          ],
          block_id: [
            'blockId-all',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId2',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-2',
            'doc-3',
            'doc-4',
            'doc-5',
            'doc-6',
            'doc-7',
            'doc-8',
            'doc-9',
            'doc-10',
            'doc-1',
          ],
        },
      },
      {
        fields: {
          additional: [
            '{"foo": "bar3"}',
          ],
          block_id: [
            'blockId4',
          ],
          doc_id: [
            'doc-0',
          ],
          parent_block_id: [
            'parentBlockId4',
          ],
          parent_flavour: [
            'affine:database',
          ],
          ref_doc_id: [
            'doc-10',
          ],
        },
      },
    ]

## should search doc title support stemmer filter

> Snapshot 1

    {
      _id: 'workspace-test-doc-title-stemmer-filter/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-stemmer-filter',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'Deploy on Windows by a designer',
        ],
      },
      highlights: {
        title: [
          'Deploy on <b>Windows</b> by a designer',
        ],
      },
    }

> Snapshot 2

    {
      _id: 'workspace-test-doc-title-stemmer-filter/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-stemmer-filter',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'Deploy on Windows by a designer',
        ],
      },
      highlights: {
        title: [
          'Deploy on <b>Windows</b> by a designer',
        ],
      },
    }

> Snapshot 3

    {
      _id: 'workspace-test-doc-title-stemmer-filter/doc-0',
      _source: {
        doc_id: 'doc-0',
        workspace_id: 'workspace-test-doc-title-stemmer-filter',
      },
      fields: {
        doc_id: [
          'doc-0',
        ],
        title: [
          'Deploy on Windows by a designer',
        ],
      },
      highlights: {
        title: [
          'Deploy on Windows by a <b>designer</b>',
        ],
      },
    }

## should return empty string field:summary value

> Snapshot 1

    [
      {
        _id: 'workspaceId-search-query-return-empty-string-field-summary-value-for-elasticsearch/doc0',
        _source: {
          doc_id: 'doc0',
          workspace_id: 'workspaceId-search-query-return-empty-string-field-summary-value-for-elasticsearch',
        },
        fields: {
          doc_id: [
            'doc0',
          ],
          summary: [
            '',
          ],
          title: [
            '',
          ],
        },
        highlights: undefined,
      },
    ]

## should not return not exists field:ref_doc_id

> Snapshot 1

    [
      {
        _id: 'workspaceId-search-query-not-return-not-exists-field-ref_doc_id-for-elasticsearch/doc0/block0',
        _source: {
          doc_id: 'doc0',
          workspace_id: 'workspaceId-search-query-not-return-not-exists-field-ref_doc_id-for-elasticsearch',
        },
        fields: {
          block_id: [
            'block0',
          ],
          doc_id: [
            'doc0',
          ],
        },
        highlights: undefined,
      },
    ]

## should aggregate query work

> Snapshot 1

    [
      {
        _id: 'workspaceId1/docId9/blockId9',
        _source: {
          doc_id: 'docId9',
          workspace_id: 'workspaceId1',
        },
        fields: {
          block_id: [
            'blockId9',
          ],
          flavour: [
            'affine:page',
          ],
        },
        highlights: {
          content: [
            'title9 <b>hello</b> affine issue <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b>, <b>hello</b> <b>hello</b> <b>hello</b>',
            '<b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b> <b>hello</b>',
          ],
        },
      },
    ]

## should aggregate query return top score first

> Snapshot 1

    [
      {
        count: 1,
        hits: [
          {
            _id: 'aggregate-test-workspace-top-score-max-first/doc-0/block-0',
            _source: {
              doc_id: 'doc-0',
              workspace_id: 'aggregate-test-workspace-top-score-max-first',
            },
            fields: {
              block_id: [
                'block-0',
              ],
              flavour: [
                'affine:page',
              ],
            },
            highlights: {
              content: [
                '<b>0.15</b> - <b>week</b>.<b>1</b>进度',
              ],
            },
          },
        ],
        key: 'doc-0',
      },
      {
        count: 2,
        hits: [
          {
            _id: 'aggregate-test-workspace-top-score-max-first/doc-10/block-10-1',
            _source: {
              doc_id: 'doc-10',
              workspace_id: 'aggregate-test-workspace-top-score-max-first',
            },
            fields: {
              block_id: [
                'block-10-1',
              ],
              flavour: [
                'affine:paragraph',
              ],
            },
            highlights: {
              content: [
                'Example <b>1</b>',
              ],
            },
          },
          {
            _id: 'aggregate-test-workspace-top-score-max-first/doc-10/block-10-2',
            _source: {
              doc_id: 'doc-10',
              workspace_id: 'aggregate-test-workspace-top-score-max-first',
            },
            fields: {
              block_id: [
                'block-10-2',
              ],
              flavour: [
                'affine:paragraph',
              ],
            },
            highlights: {
              content: [
                'Single substitution format <b>1</b>',
              ],
            },
          },
        ],
        key: 'doc-10',
      },
    ]

> Snapshot 2

    [
      {
        count: 1,
        hits: [
          {
            _id: 'aggregate-test-workspace-top-score-max-first/doc-0/block-0',
            _source: {
              doc_id: 'doc-0',
              workspace_id: 'aggregate-test-workspace-top-score-max-first',
            },
            fields: {
              block_id: [
                'block-0',
              ],
              flavour: [
                'affine:page',
              ],
            },
            highlights: {
              content: [
                '<b>0.15</b> - <b>week</b>.<b>1</b>进度',
              ],
            },
          },
        ],
        key: 'doc-0',
      },
    ]
